<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>简单的html5 File测试 for pic2base64</title>
    <style>
    </style>
    <script>
        document.getElementById("file").addEventListener("change", function () {
            var fileReader = new FileReader(),
                box = document.getElementById('box'),
                blobSlice = File.prototype.mozSlice || File.prototype.webkitSlice || File.prototype.slice,
                file = document.getElementById("file").files[0],
                chunkSize = 2097152,
                chunks = Math.ceil(file.size / chunkSize),
                currentChunk = 0,
                bs = fileReader.readAsBinaryString,
                spark = bs ? new SparkMD5() : new SparkMD5.ArrayBuffer();

            fileReader.onload = function (ee) {
                spark.append(ee.target.result);
                currentChunk++;

                if (currentChunk < chunks) {
                    loadNext();
                } else {
                    var md5 = spark.end();
                    box.innerText = 'MD5:  ' + md5;
                    $('#MD5').val(md5);
                }
            }

            function loadNext() {
                var start = currentChunk * chunkSize, end = start + chunkSize >= file.size ? file.size : start + chunkSize;
                if (bs) fileReader.readAsBinaryString(blobSlice.call(file, start, end));
                else fileReader.readAsArrayBuffer(blobSlice.call(file, start, end));
            }

            loadNext();
        });

    </script>
</head>
<body>
<div class="form-group">
    <label for="img" class="col-sm-2 control-label">文件</label>
    <div class="col-sm-8">
        <input class="form-control" type="file" style="height:auto;"
               id="file" name="file" onchange="imgPreview(this)"
        />
        <img style="max-width:100%;height:auto;margin-top: 10px" id="imgpreview" />
    </div>
    <div id="box"></div>
</div>
<input type="hidden" id="MD5" name="MD5"/>
</body>
</html>
